<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informacion del cliente</title>
    <link rel="stylesheet"
          type="text/css"
          href="../node_modules/bootstrap/dist/css/bootstrap.css"/>
    <style>
        main { 
            margin-top: 2%;
            padding-left: 30%;
            padding-right: 30%;
        }
        form {
            height: 70%;
        }
        .banner {
            background-color: maroon;
            padding: 4%;
        }
    </style>
</head>
<body>
    <main class="container">
        <div class="container rounded-top banner">
            <img class="" src="../IMGs/librePensador2.webp" height="19%" width="19%">
        </div>
        <form class="shadow p-3 mb-5 bg-body rounded" id="customerForm">
            <div class="mb-3">
              <label for="email" class="form-label">Email del cliente</label>
              <input type="email" class="form-control" id="email" disabled>
            </div>
            <div class="mb-3">
              <label for="name" class="form-label">Nombre del cliente</label>
              <input type="text" class="form-control" id="name" disabled>
            </div>
            <div class="mb-3">
                <label for="phone_number" class="form-label">Numero celular</label>
                <input type="text" class="form-control" id="phone_number" disabled>
            </div>
            <div class="mb-3">
                <label for="address" class="form-label">Direccion</label>
                <input type="text" class="form-control" id="address" disabled>
            </div>
            <div class="mb-3">
                <label for="total_points" class="form-label">Total de puntos</label>
                <input type="text" class="form-control" id="total_points" disabled>
            </div>
            <div class="mb-3">
                <label for="date_of_birth" class="form-label">Fecha de nacimiento</label>
                <input type="text" class="form-control" id="date_of_birth" disabled>
            </div>

            <button onclick="tryUnlinkCustomerFromCard(event)"class="btn btn-primary" id="btnAction" disabled>Des enlazar cliente de la tarjeta</button>
            <input type="button" onclick="returnToScanner()" class="btn btn-secondary" value="Cancelar">
        </form>
    </main>
    <script type="module">
        import { initCustomerData } from '../scripts/scanCard/initCustomerData.js';

        document.addEventListener('DOMContentLoaded', async () => await initCustomerData("scanner.html"));
    </script>
    <script type="module">
        import { updateCard } from '../scripts/updateCard.js';
        import { deleteCustomer } from '../scripts/deleteCustomer.js';

        async function tryUnlinkCustomerFromCard(event) {
            event.preventDefault();

            const cardId = sessionStorage.getItem("scannedCardCode");
            const customerEmail = document.getElementById("email").value;
            
            const updatedCard = await updateCard(cardId, null);
            const deletedCustomer = await deleteCustomer(customerEmail);

            if(updatedCard == null || deletedCustomer == null) {
                alert("Error inesperado: ocurrio un error al intentar desenlazar la tarjeta del cliente");
                returnToScanner();
                return;
            }
            if(updatedCard.customerEmail != null)  {
                alert("Error inesperado: la tarjeta no fue desenlazada correctamente");
                returnToScanner();
                return;
            }
            if(deletedCustomer.email != customerEmail) {
                alert("Error inesperado: el cliente eliminado no es el cliente que estaba enlazado a la tarjeta escaneada \n Cliente eliminado: " + deletedCustomer.email);
                returnToScanner();
                return;
            }

            alert(`La tarjeta escaneada fue desenlazada exitosamente del cliente con email: ${ deletedCustomer.email }`);
            returnToScanner();
        }

        function returnToScanner() {
            window.location.href = "scanner.html";
        }

        window.returnToScanner = returnToScanner;
        window.tryUnlinkCustomerFromCard = tryUnlinkCustomerFromCard;
    </script>
</body>
</html>
